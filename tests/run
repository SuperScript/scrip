#!/bin/sh

home="$(pwd)"
_sort="env LC_ALL=POSIX sort"

PATH="${home}/src:$PATH"
export PATH

scrip=scrip
basedir="${home}/tests/basedir"

####

# _silence prog
_silence() {
  "$@" >/dev/null 2>&1
}

# _sanitize < input > output
_sanitize() {
  sed \
    -e "s!${home}!...!"g
}

# _check prog
_check() {
  { "$@" 2>&1 ; echo $?; } | _sanitize
}

# _check_err prog
_check_err() {
  { "$@" 2>&1 >/dev/null ; echo $?; } | grep -E 'fatal:|(^[0-9]+)' | _sanitize
}

# _check_sort prog
_check_sort() {
  _check "$@" | ${_sort}
}

# _run headline
_run() {
  printf '\n\n#### %s\n\n' "$1"
}

####

cd tests
rm -rf "${basedir}"

_run 'scrip help offers help'
_check ${scrip} help

_run 'scrip deps lists dependencies'
mkdir -p "${basedir}"
cat - > "${basedir}/scriptest" <<'EOF'
#!/bin/sh
#include "safe.sh"
safe nosuchprogram
EOF

_check env SCRIP_PATH="${home}/lib" ${scrip} deps "${basedir}/scriptest"


_run 'shout prints message to stderr'
cat - > "${basedir}/shout_test.sh" <<'EOF'
#!/bin/sh
#include "shout.sh"
shout "test message"
EOF

env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/shout_test.sh" > "${basedir}/shout_test"
_check sh "${basedir}/shout_test"

_run 'shout.awk prints message to stderr'
cat - > "${basedir}/shout_awk_test.awk" <<'EOF'
#include "shout.awk"
BEGIN { shout("test message"); }
EOF

env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/shout_awk_test.awk" > "${basedir}/shout_awk_test"
_check awk -f "${basedir}/shout_awk_test"


_run 'barf prints fatal message and exits with 111'
cat - > "${basedir}/barf_test.sh" <<'EOF'
#!/bin/sh
#include "barf.sh"
barf "test error"
EOF

env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/barf_test.sh" > "${basedir}/barf_test"
_check sh "${basedir}/barf_test"

_run 'barf.awk prints fatal message and exits with 111'
cat - > "${basedir}/barf_awk_test.awk" <<'EOF'
#include "barf.awk"
BEGIN { barf("test error"); }
EOF

env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/barf_awk_test.awk" > "${basedir}/barf_awk_test"
_check awk -f "${basedir}/barf_awk_test"

_run 'scrip code resolves includes'
_check env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/scriptest"


_run 'safe succeeds with valid command'
cat - > "${basedir}/safe_success.sh" <<'EOF'
#!/bin/sh
#include "safe.sh"
safe echo "hello world"
EOF

env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/safe_success.sh" > "${basedir}/safe_success"
_check sh "${basedir}/safe_success"


_run 'safe fails and shows error'
cat - > "${basedir}/safe_fail.sh" <<'EOF'
#!/bin/sh
#include "safe.sh"
safe false
EOF

env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/safe_fail.sh" > "${basedir}/safe_fail"
_check sh "${basedir}/safe_fail"


exit 0

