#!/bin/sh

home="$(pwd)"
_sort="env LC_ALL=POSIX sort"

PATH="${home}/src:$PATH"
export PATH

scrip=scrip
basedir="${home}/tests/basedir"

####

# _silence prog
_silence() {
  "$@" >/dev/null 2>&1
}

# _sanitize < input > output
_sanitize() {
  sed \
    -e "s!${home}!...!"g
}

# _check prog
_check() {
  { "$@" 2>&1 ; echo $?; } | _sanitize
}

# _check_err prog
_check_err() {
  { "$@" 2>&1 >/dev/null ; echo $?; } | grep -E 'fatal:|(^[0-9]+)' | _sanitize
}

# _check_sort prog
_check_sort() {
  _check "$@" | ${_sort}
}

# _run headline
_run() {
  printf '\n\n#### %s\n\n' "$1"
}

####

cd tests
rm -rf "${basedir}"

_run 'scrip help offers help'
_check ${scrip} help

_run 'scrip deps lists dependencies'
mkdir -p "${basedir}"
cat - > "${basedir}/scriptest" <<'EOF'
#!/bin/sh
#include "safe.sh"
safe nosuchprogram
EOF

_check env SCRIP_PATH="${home}/lib" ${scrip} deps "${basedir}/scriptest"

_run 'scrip code resolves includes'
_check env SCRIP_PATH="${home}/lib" ${scrip} code "${basedir}/scriptest"

exit 0

